' Gambas class file

Static Private sprite As CSprite

Public Sub Form_Open()
  
  FMain.Resize(1280, 720)
  
  LayerSplit.Layout = [1, 4]
  FrameSplit.Layout = [1, 5]
  AnimSplit.Layout = [1, 6]
  
  Dialog.Path = "."
  
  sprite = New CSprite
  sprite.Saved = False
  
  sprite.Animations = New CAnimation[]
  sprite.ChildSelected = 0
  sprite.ChildrenCreated = 0

End

Public Sub Quit_Click()

  Me.Close

End

Public Sub RefreshAList()
  
  Dim uuidA As Integer = 0
  Dim numAnimations As Integer = sprite.Animations.Length
  
  AnimationList.Clear
  
  For uuidA = 0 To (numAnimations - 1) 'Zero Indexed!
    AnimationList.Add(uuidA, sprite.Animations[uuidA].Name)
  Next
  
  'retain selection
  If sprite.Animations.Length > 0
    AnimationList.MoveTo(sprite.ChildSelected)
    AnimationList.Item.Selected = True
  Endif
  
End

Public Sub RefreshFList()
  
  Dim uuidF As Integer = 0
  Dim numFrames As Integer = sprite.Animations[sprite.ChildSelected].Frames.Length
  
  FrameList.Clear
  
  For uuidF = 0 To (numFrames - 1)
    FrameList.Add(uuidF, sprite.Animations[sprite.ChildSelected].Frames[uuidF].Name)
  Next
  
  'retain selection
  If sprite.Animations[sprite.ChildSelected].Frames.Length >= 0
    FrameList.MoveTo(sprite.Animations[sprite.ChildSelected].ChildSelected)
    FrameList.Item.Selected = True
  Endif

End

Public Sub Canvas_Draw()

  Dim DefaultX As Integer = 1280
  Dim DefaultY As Integer = 720
  
  Dim PadFromEdge As Integer = 10
  
  Dim ScaledX, ScaledY, PadX, PadY As Integer
  Dim Ratio, RatioX, RatioY As Float
  
  Dim CenterX As Integer = Canvas.W / 2
  Dim CenterY As Integer = Canvas.H / 2
  
  Dim Dashes As Float[] = [1.0, 1.0]
  
  If Canvas.W / DefaultX >= Canvas.H / DefaultY Then
    Ratio = Canvas.H / DefaultY * 0.9
  Else
    Ratio = Canvas.W / DefaultX * 0.9
  Endif
  
  Paint.Reset
  
  Paint.LineWidth = 1
  Paint.Brush = Paint.Color(Color.Black)
  Paint.Rectangle(CenterX - (DefaultX / 2 * Ratio), CenterY - (DefaultY / 2 * Ratio), DefaultX * Ratio, DefaultY * Ratio)
  Paint.Stroke
  
  Paint.Dash = Dashes
  Paint.Brush = Paint.Color(Color.White)
  Paint.Rectangle(CenterX - (DefaultX / 2 * Ratio), CenterY - (DefaultY / 2 * Ratio), DefaultX * Ratio, DefaultY * Ratio)
  Paint.Stroke

End

Public Sub LayerButtonImage_Click()
  
  Dialog.Filter = ["*.png;*.jpg;*.jpeg;*.bmp", "Picture files"]
  If Dialog.OpenFile() Then
    Print "cancel"
  Else
    Print Dialog.Path
  Endif

End


Public Sub AnimButtonAdd_Click()
  
  Dim tmpString As String
  Dim newAnimation As CAnimation = New CAnimation
  newAnimation.Frames = New CFrame[]
  
  sprite.ChildrenCreated += 1
  tmpString = "animation_" & CStr(sprite.ChildrenCreated)
  
  newAnimation.ChildrenCreated = 0
  newAnimation.ChildSelected = 0
  newAnimation.Name = tmpString
  
  sprite.Animations.Add(newAnimation)
  
  AnimLengthLabel.Text = sprite.Animations.Length
  
  RefreshAList()

End

Public Sub AnimationList_Select()
  
  Dim currentKey As Integer
  Dim addFrame As Boolean = False
  
  sprite.ChildSelected = AnimationList.Current.Key
  
  currentKey = sprite.ChildSelected + 1
  
  AnimSelectedLabel.Text = currentKey
  
  'enable top/up
  If sprite.Animations.Length > 1 And AnimationList.Selection.Length > 0 And currentKey > 1 Then
    AnimButtonTop.Enabled = True
    AnimButtonUp.Enabled = True
    addFrame = True
  Else If sprite.Animations.Length < 2 Or AnimationList.Selection.Length == 0 Or currentKey == 1 Then
    AnimButtonTop.Enabled = False
    AnimButtonUp.Enabled = False
  Endif
  
  'enable bottom/down
  If sprite.Animations.Length > 1 And AnimationList.Selection.Length > 0 And currentKey < sprite.Animations.Length Then
    AnimButtonBottom.Enabled = True
    AnimButtonDown.Enabled = True
    addFrame = True
  Else If sprite.Animations.Length < 2 Or AnimationList.Selection.Length == 0 Or currentKey == sprite.Animations.Length Then
    AnimButtonBottom.Enabled = False
    AnimButtonDown.Enabled = False
  Endif
  
  FrameButtonAdd.Enabled = addFrame
  
  If sprite.Animations[sprite.ChildSelected].Frames.Length > 0
    RefreshFList()
  Else
    FrameList.Clear
  Endif
  
End

Public Sub AnimationList_Rename()
  
  Dim currentKey As Integer = AnimationList.Current.Key
  
  sprite.Animations[currentKey].Name = AnimationList.Current.Text

End

Public Sub AnimationList_DblClick()
  
  AnimationList.Current.Rename

End

Public Sub AnimButtonTop_Click()

  Dim currentKey As Integer = AnimationList.Current.Key
  
  sprite.Animations.Add(sprite.Animations[currentKey], 0)
  sprite.Animations.Remove(currentKey + 1)
  
  RefreshAList()
  
  AnimationList.MoveTo("0")
  AnimationList.Item.Selected = True
  
End


Public Sub AnimButtonUp_Click()

  Dim currentKey As Integer = AnimationList.Current.Key
  
  sprite.Animations.Add(sprite.Animations[currentKey], currentKey - 1)
  sprite.Animations.Remove(currentKey + 1)
  
  RefreshAList()
  
  AnimationList.MoveTo(currentKey - 1)
  AnimationList.Item.Selected = True

End

Public Sub AnimButtonBottom_Click()
  
  Dim currentKey As Integer = AnimationList.Current.Key
  
  sprite.Animations.Add(sprite.Animations[currentKey])
  sprite.Animations.Remove(currentKey)
  
  RefreshAList()
  
  AnimationList.MoveTo(sprite.Animations.Length - 1)
  AnimationList.Item.Selected = True

End

Public Sub AnimButtonDown_Click()

  Dim currentKey As Integer = AnimationList.Current.Key
  
  sprite.Animations.Add(sprite.Animations[currentKey], currentKey + 2)
  sprite.Animations.Remove(currentKey)
  
  RefreshAList()
  
  AnimationList.MoveTo(currentKey + 1)
  AnimationList.Item.Selected = True
  
End

Public Sub FrameButtonAdd_Click()
  
  Dim tmpString As String
  Dim newFrame As CFrame = New CFrame
  newFrame.Layers = New CLayer[]
  
  sprite.Animations[sprite.ChildSelected].ChildrenCreated += 1
  tmpString = "frame_" & CStr(sprite.Animations[sprite.ChildSelected].ChildrenCreated)
  
  newFrame.ChildrenCreated = 0
  newFrame.ChildSelected = 0
  newFrame.Name = tmpString
  
  sprite.Animations[sprite.ChildSelected].Frames.Add(newFrame)
  
  FrameLengthLabel.Text = sprite.Animations[sprite.ChildSelected].Frames.Length
  
  RefreshFList()

End

Public Sub FrameList_Select()
  
  Dim currentKey As Integer
  Dim addLayer As Boolean = False
  
  sprite.Animations[sprite.ChildSelected].ChildSelected = FrameList.Current.Key
  
  currentKey = sprite.Animations[sprite.ChildSelected].ChildSelected + 1
  
  FrameSelectedLabel.Text = currentKey
  
  'enable top/up
  If sprite.Animations[sprite.ChildSelected].Frames.Length > 1 And FrameList.Selection.Length > 0 And currentKey > 1 Then
    FrameButtonTop.Enabled = True
    FrameButtonUp.Enabled = True
    addLayer = True
  Else If sprite.Animations[sprite.ChildSelected].Frames.Length < 2 Or FrameList.Selection.Length == 0 Or currentKey == 1 Then
    FrameButtonTop.Enabled = False
    FrameButtonUp.Enabled = False
  Endif
  
  'enable bottom/down
  If sprite.Animations[sprite.ChildSelected].Frames.Length > 1 And FrameList.Selection.Length > 0 And currentKey < sprite.Animations[sprite.ChildSelected].Frames.Length Then
    AnimButtonBottom.Enabled = True
    AnimButtonDown.Enabled = True
    addLayer = True
  Else If sprite.Animations[sprite.ChildSelected].Frames.Length < 2 Or FrameList.Selection.Length == 0 Or currentKey == sprite.Animations[sprite.ChildSelected].Frames.Length Then
    AnimButtonBottom.Enabled = False
    AnimButtonDown.Enabled = False
  Endif
  
  LayerButtonAdd.Enabled = addLayer
  
  If sprite.Animations[sprite.ChildSelected].Frames.Length > 0
    'RefreshLList()
  Else
    LayerList.Clear
  Endif
  
End

Public Sub FrameList_Rename()
  
  Dim currentKey As Integer = FrameList.Current.Key
  
  sprite.Animations[sprite.ChildSelected].Frames[currentKey].Name = FrameList.Current.Text

End

Public Sub FrameList_DblClick()

  FrameList.Current.Rename

End
